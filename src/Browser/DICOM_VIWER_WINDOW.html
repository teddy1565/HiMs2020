<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'">

<html>
    <head>
        <script type="text/javascript" src="../UIresource/jquery-3.5.1.js" onload="window.$ = window.jQuery"></script>
        <link rel="stylesheet" href="../UIresource/bootstrap-4.5.3-dist/css/bootstrap.css">
        <script src="../UIresource/bootstrap-4.5.3-dist/js/bootstrap.bundle.js"></script>
        <script type="module" src="../../node_modules/cornerstone-core/dist/cornerstone.min.js"></script>
        <script type="module" src="../../node_modules/cornerstone-math/dist/cornerstoneMath.min.js"></script>
        <script type="module" src="../../node_modules/cornerstone-tools/dist/cornerstoneTools.min.js"> </script>
        <script type="module" src="../../node_modules/hammerjs/hammer.js"></script>
        <script type="module" src="../../node_modules/dicom-parser/dist/dicomParser.js"></script>
        <script type="module" src="../../node_modules/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoader.js">
            
        </script>
    </head>
    <body>
        <div id="dicomImage" style="width:512px;height:512px;">
            <canvas>

            </canvas>
        </div>
        <div class="container">
            <input type="text" class="input-group" id="PATID">
            <button class="btn btn-success" onclick="load()">LOAD IMAGE</button>
            <button class="btn btn-success" onclick="GetStudyList()">取得Study影像清單</button>
            <button class="btn btn-success" onclick="dcm_sqrt()">DICOM排序</button>
            <button class="btn btn-warning" onclick="clearInfo()">清除infoBoard</button>
            <button class="btn btn-danger" onclick="clearImageList()">清除記憶體</button>
            <button class="btn btn-success" onclick="openDICOM()">開啟檔案</button>
        </div>
        <div id="infoBoard">

        </div>
        
    </body>
</html>
<script>
    window.onload = ()=>{
        function reg(patID){
            const promise = new Promise((resolve,reject)=>{
                resolve(images[0].Data[0].Data);
            });
            return {promise};
        }
        cornerstone.registerUnknownImageLoader(reg);
        cornerstoneTools.external.cornerstone=cornerstone;
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        var config = {
            maxWebWorkers: navigator.hardwareConcurrency || 1,
            startWebWorkersOnDemand : true,
        };
        cornerstoneWADOImageLoader.webWorkerManager.initialize(config);
    }
    function openDICOM(){
        
        let element = document.getElementById('dicomImage');
        let imageId = 'http://a/fuck.dcm';
        cornerstone.enable(element);
        cornerstone.loadImage(imageId).then((image)=>{
            cornerstone.displayImage(element, image);

            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);
            cornerstoneTools.wwwc.activate(element, 1); // Left Click
            cornerstoneTools.pan.activate(element, 2); // Middle Click
            cornerstoneTools.zoom.activate(element, 4); // Right Click
            cornerstoneTools.zoomWheel.activate(element); // Mouse Wheel
        });
    }
    let images=[];
    function GetStudyList(){
        let PATID = document.getElementById("PATID").value;
        window.ipcRenderer.send("GETImage",`${PATID}`);
    }
    function load(){
        let PATID = document.getElementById("PATID").value;
        window.ipcRenderer.send("GETImage",`${PATID}`);
    }
    window.ipcRenderer.receive("FILE",(args)=>{
        images.push(args);
    });
    window.ipcRenderer.receive("Info",(args)=>{
        document.getElementById("infoBoard").innerHTML+=`<p>${args}</p>`;
    });
    function DICOM_sqrt(images){
        let Studys=[];
        for(let i in images){
            let find = false;
            for(let j in Studys){
                if(images[i].Study==Studys[j].Study){
                    Studys[j].Data.push(images[i]);
                    find=true;
                    break;
                }
            }
            if(find==false){
                let pushData = {
                    "Study":`${images[i].Study}`,
                    Data:[]
                }
                pushData.Data.push(images[i]);
                Studys.push(pushData);
            }
        }
        return Studys;
    }
    function clearInfo(){
        document.getElementById("dicomImage").style.display="none";
        document.getElementById("infoBoard").innerHTML = "";
    }
    function clearImageList(){
        document.getElementById("dicomImage").style.display="none";
        images=[];
    }
    function dcm_sqrt(){
        images = DICOM_sqrt(images);
    }
    window.ipcRenderer.receive("StudyList",(args)=>{
        document.getElementById("infoBoard").innerHTML="";
        for(let i in args){
            document.getElementById("infoBoard").innerHTML +=`<p>${args[i]}</p>`;
        }
    });
    // window.ipcRenderer.receive("StudyList",(args)=>{
    //     for(let i in args){
    //         document.getElementById("InfoBoard").innerHTML+=`<p>${args[i]}</p>`;
    //     }
    // });
</script>