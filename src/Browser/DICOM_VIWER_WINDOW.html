<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'">
<script type="text/javascript" src="../UIresource/jquery-3.5.1.js" onload="window.$ = window.jQuery"></script>
<html>
    <head>
        <script type="module" src="../../node_modules/hammerjs/hammer.js"></script>
        <script type="module" src="../../node_modules/cornerstone-core/dist/cornerstone.js"></script>
        <script type="module" src="../../node_modules/cornerstone-math/dist/cornerstoneMath.js"></script>
        <script type="module" src="../../node_modules/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoader.js"></script>
        <script type="module" src="../../node_modules/cornerstone-tools/dist/cornerstoneTools.js"></script>
        <link rel="stylesheet" href="../UIresource/bootstrap-4.5.3-dist/css/bootstrap.css">
        <script src="../UIresource/bootstrap-4.5.3-dist/js/bootstrap.bundle.js"></script>
    </head>
    <body>
        
        <div class="container">
            <button class="btn btn-success" onclick="load()">LOAD IMAGE</button>
            <button class="btn btn-success" onclick="dcm_sqrt()">DICOM排序</button>
            <button class="btn btn-warning" onclick="clearInfo()">清除infoBoard</button>
            <button class="btn btn-danger" onclick="clearImageList()">清除記憶體</button>
            <button class="btn btn-success" onclick="openDICOM()">開啟檔案</button>
        </div>
        <div id="infoBoard">

        </div>
        <div id="dicomImage" style="width:512px;height:512px">

        </div>
    </body>
</html>
<script>
    function openDICOM(){
        let imageId = images[0].Data[0].Data.toString('base64');
        let element = document.getElementById('dicomImage');
        cornerstone.enable(element);
        cornerstone.loadImage(imageId).then(function(image) {
            cornerstone.displayImage(element, image);
        });
    }
    let images=[];
    function load(){
        window.ipcRenderer.send("GETImage","GiveMeImage");
        images=[];
        document.getElementById("infoBoard").innerHTML="";
    }
    window.ipcRenderer.receive("FILE",(args)=>{
        images.push(args);
    });
    window.ipcRenderer.receive("Info",(args)=>{
        document.getElementById("infoBoard").innerHTML+=`<p>${args}</p>`;
    });
    function DICOM_sqrt(images){
        let Studys=[];
        for(let i in images){
            let find = false;
            for(let j in Studys){
                if(images[i].Study==Studys[j].Study){
                    Studys[j].Data.push(images[i]);
                    find=true;
                    break;
                }
            }
            if(find==false){
                let pushData = {
                    "Study":`${images[i].Study}`,
                    Data:[]
                }
                pushData.Data.push(images[i]);
                Studys.push(pushData);
            }
        }
        return Studys;
    }
    function clearInfo(){
        document.getElementById("infoBoard").innerHTML = "";
    }
    function clearImageList(){
        images=[];
    }
    function dcm_sqrt(){
        images = DICOM_sqrt(images);
    }
</script>